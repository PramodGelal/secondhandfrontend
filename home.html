<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Second-Hand Market</title>
  <link rel="icon" href="favicon-96x96.png" type="image/png" />
  <link rel="stylesheet" href="header-footer.css">
  <link rel="stylesheet" href="navigation_bar.css">
  <link rel="stylesheet" href="items.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
    }

    /* Button hover effect for all buttons */
    button {
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #00796b !important; /* dark teal hover */
      transform: scale(1.05);
    }

    .main-content-wrapper {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 10px;
      gap: 10px;
    }

    .ad-box-vertical {
      width: 150px;
      background-color: #ebf0ed;
      border: 1px solid #e1ddd5;
      margin-top: 20px;
      padding: 5px;
      border-radius: 10px;
      height: 520px; /* fixed height for ad */
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .ad-box-vertical img {
      width: 100%;
      height: 500px;
      border-radius: 10px;
      object-fit: cover;
      user-select: none;
      pointer-events: none;
    }

    #itemContainerGrouped {
      flex: 1;
      margin: 20px 0 30px 0;
    }

    .category-block {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .category-block h2 {
      margin-bottom: 10px;
      color: #333;
    }

    .item-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .item-card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 220px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }

    .item-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .item-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .item-details {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .item-details h3 {
      font-size: 16px;
      margin: 0;
      color: #333;
    }

    .price-buy-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-price {
      font-weight: bold;
      color: #009688;
      font-size: 14px;
    }

    .item-details button {
      background-color: #ff6f00;
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }

    .item-details button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none !important;
    }

    .stock-status {
      font-size: 12px;
      margin-top: 4px;
    }

    .category-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .category-controls button {
      background-color: #009688;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .category-controls button:hover {
      background-color: #00796b;
      transform: scale(1.05);
    }

    footer.footer {
      margin-top: 30px;
      background-color: #333;
      color: #eee;
      padding: 15px 0;
      text-align: center;
    }
    /* Chat Styles */
.chat-container {
  padding: 10px;
}

.chat-back-btn {
  background-color: #009688;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 10px;
}

.chat-header {
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}

.seller-status {
  font-size: 12px;
  color: #4CAF50;
  margin-top: 5px;
}

.payment-history {
  margin-bottom: 15px;
}

.payment-list {
  max-height: 150px;
  overflow-y: auto;
  margin-top: 10px;
}

.payment-item {
  padding: 8px;
  margin-bottom: 8px;
  background-color: #f9f9f9;
  border-radius: 5px;
}

.payment-item-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
}

.item-name {
  font-weight: bold;
}

.item-price {
  color: #009688;
}

.payment-date {
  font-size: 12px;
  color: #666;
}

.chat-messages {
  height: 250px;
  overflow-y: auto;
  padding: 10px;
  background-color: #f5f5f5;
  border-radius: 5px;
  margin-bottom: 10px;
}

.message {
  margin-bottom: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  max-width: 80%;
}

.message.sent {
  background-color: #DCF8C6;
  margin-left: auto;
  border-top-right-radius: 0;
}

.message.received {
  background-color: #ECECEC;
  margin-right: auto;
  border-top-left-radius: 0;
}

.message-sender {
  font-weight: bold;
  font-size: 12px;
  margin-bottom: 3px;
}

.message-content {
  word-wrap: break-word;
}

.message-time {
  font-size: 10px;
  color: #666;
  text-align: right;
  margin-top: 3px;
}

.message-input-container {
  display: flex;
  gap: 5px;
}

.message-input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.send-button {
  background-color: #009688;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 0 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.loading-spinner {
  text-align: center;
  padding: 20px;
  color: #666;
}

.error-message {
  color: #f44336;
  padding: 10px;
  text-align: center;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 10px 15px;
  border-radius: 4px;
  z-index: 1000;
}

.notification.error {
  background-color: #f44336;
  color: white;
}

.notification.success {
  background-color: #4CAF50;
  color: white;
}
  </style>
<body>
<div class="top-header" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background-color: black; color: white;">

  <!-- Logo -->
  <a href="home.html" style="text-decoration: none; color: yellow; font-weight: bold; font-size: 24px; cursor: pointer;">
    <div class="logo" data-i18n="site.logo">SecondHand</div>
  </a>

  <!-- Search Bar + Language -->
  <div style="display: flex; align-items: center; gap: 15px;">
   <div class="search-bar" style="
  display: flex;
  align-items: center;
  gap: 8px;
  background-color: #fff;
  padding: 4px 10px;
  border-radius: 10px;
  box-shadow: 0 1px 6px rgba(0, 0, 0, 0.08);
  max-width: 700px;
  width: 100%;
  height: 30px;
">

  <!-- Category Filter -->
  <select id="categoryFilter" aria-label="Category Filter" style="
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    font-size: 13px;
    height: 28px;
    cursor: pointer;
  ">
    <option value="all" data-i18n="site.categoryAll">All</option>
    <option value="electronics" data-i18n="site.categoryElectronics">Electronics</option>
    <option value="books" data-i18n="site.categoryBooks">Books</option>
    <option value="clothing" data-i18n="site.categoryClothing">Clothing</option>
  </select>

  <!-- Search Input -->
  <input type="text" id="searchInput" placeholder="" data-i18n-placeholder="site.searchPlaceholder" aria-label="Search Items" style="
    flex: 1;
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    outline: none;
    font-size: 13px;
    height: 15px;
  " />

  <!-- Search Button -->
  <button id="searchBtn" aria-label="Search Button" style="
    background-color: #ffcc00;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    height: 30px;
    transition: background-color 0.2s;
  " onmouseover="this.style.backgroundColor='#ffdb4d'" onmouseout="this.style.backgroundColor='#ffcc00'">
    üîç
  </button>
</div>


    <!-- Language Selector -->
    <select id="languageSelect" aria-label="Select Language"
      style="padding: 6px 10px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;">
      <option value="en">English</option>
      <option value="np">‡§®‡•á‡§™‡§æ‡§≤‡•Ä</option>
    </select>
  </div>

<div class="right-section" style="display: flex; flex-direction: column; align-items: flex-end; gap: 12px; position: relative;">
 <div> <button id="messageBtn" title="Messages"
    style="font-size: 18px; background-color: black; color: yellow; border: 2px solid yellow; border-radius: 50%; width: 36px; height: 36px; cursor: pointer;">üí¨</button>
 
 <button id="historyBtn"
      style="font-size: 18px; background-color: black; color: yellow; border: 2px solid yellow; border-radius: 50%; width: 36px; height: 36px; cursor: pointer;">
      üìú
    </button>
    <button onclick="toggleSettingsMenu()" title="Settings"
    style="font-size: 18px; background-color: black; color: yellow; border: 2px solid yellow; border-radius: 50%; width: 36px; height: 36px; cursor: pointer;">‚öôÔ∏è</button>

  <div id="settingsMenu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 1000;">
       <a href="#" onclick="redirectNoBack('login1.html')" data-i18n="site.signIn" style="display: block; padding: 8px 12px; text-decoration: none; color: black;">Sign in</a>
   <a href="#" onclick="redirectNoBack('sellerlogin.html')"
    style="display: block; padding: 8px 12px; text-decoration: none; color: black;">Login as seller</a>
    <button onclick="logout()" style="display: block; width: 100%; text-align: left; padding: 8px 12px; border: none; background: none; color: black; cursor: pointer;">Log out</button>
  </div></div>
  <div id="welcomeMessage" style="color: yellow; font-size: 14px;">Welcome, User</div>

 
</div>


</div>




<!-- NAVIGATION BAR -->
<div class="nav-bar" style="background-color: rgb(223, 243, 110); padding: 10px 0;">
  <div class="nav-links" style="display: flex; justify-content: left; gap: 30px; padding: 10px;">
    <a href="home.html" data-i18n="site.home" style="text-decoration: none; color: black; font-weight: bold;">Home</a>
    <a href="cat.html" data-i18n="site.categories" style="text-decoration: none; color: black; font-weight: bold;">Categories</a>
    <a href="support.html" data-i18n="site.support" style="text-decoration: none; color: black; font-weight: bold;">Support</a>
  </div>
</div>



<!-- CHATBOX -->
<div id="messageBox"
  style="display: none; position: fixed; top: 80px; right: 20px; width: 350px; height: 500px; background: white; border: 2px solid yellow; box-shadow: 0 0 12px rgba(0,0,0,0.3); border-radius: 10px; z-index: 999; overflow: hidden; cursor: move;"
  onmousedown="dragElement(this)">

  <div style="display: flex; justify-content: space-between; align-items: center; background-color: yellow; padding: 6px 10px; border-bottom: 1px solid #ccc;">
    <h4 id="chatname" style="color: black; margin: 0;">Your Messages</h4>
    <div>
     
      <button title="Close" onclick="document.getElementById('messageBox').style.display='none'" style="background: none; border: none; font-weight: bold; cursor: pointer;">‚ùå</button>
    </div>
  </div>

 <div id="messagesArea" style="
  height: 440px;
  overflow-y: auto;
  padding: 16px;
  background: #f9fafb;
  border: 1.5px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  font-size: 14px;
  color: #333;
  scrollbar-width: thin;
  scrollbar-color: #007bff #e1e4ea;
">
  <!-- Messages will appear here -->
</div>

</div>
<script>

 function redirectNoBack(url) {
    window.location.replace(url); // replaces current page in history
  }
function dragElement(elmnt) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

  const header = document.getElementById("messageHeader");
  if (header) {
    header.onmousedown = dragMouseDown;
  } else {
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;

    // If clicked element is input, textarea, or contenteditable, do NOT drag
    const target = e.target;
    if (
      target.tagName === "INPUT" || 
      target.tagName === "TEXTAREA" || 
      target.isContentEditable
    ) {
      return; // allow normal typing/focus
    }

    e.preventDefault();

    // Get the initial mouse cursor position
    pos3 = e.clientX;
    pos4 = e.clientY;

    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();

    // Calculate new cursor position
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;

    pos3 = e.clientX;
    pos4 = e.clientY;

    // Set the element's new position
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}


</script>


<div id="historyContainer"
  style="display: none; position: fixed; top: 100px; left: calc(50% - 450px); width: 500px; max-width: 100%; background: white; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.2); border-left: 5px solid yellow; z-index: 1000;">

  <!-- Draggable header with title and close button -->
  <div id="historyHeader" style="cursor: move; padding: 12px 20px; background: yellow; border-top-left-radius: 12px; border-top-right-radius: 12px; display: flex; justify-content: space-between; align-items: center; user-select: none;">
    <h2 style="margin: 0; font-weight: bold; color: black;">Purchase & Selling History</h2>
    <button id="closeHistoryBtn" 
      style="background: none; border: none; font-size: 20px; font-weight: bold; cursor: pointer; color: black;" 
      title="Close">‚úñ</button>
  </div>

  <div id="historyList" style="padding: 20px; max-height: 400px; overflow-y: auto;">
    <!-- Your purchase & selling history content goes here -->
  </div>
  
</div>

<script>
  function dragElement(elmnt, handle) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

    handle.onmousedown = dragMouseDown;

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();

      pos3 = e.clientX;
      pos4 = e.clientY;

      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();

      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;

      pos3 = e.clientX;
      pos4 = e.clientY;

      // Calculate new position within viewport bounds (optional)
      let newTop = elmnt.offsetTop - pos2;
      let newLeft = elmnt.offsetLeft - pos1;

      // Optional: keep inside window boundaries
      const minLeft = 0;
      const minTop = 0;
      const maxLeft = window.innerWidth - elmnt.offsetWidth;
      const maxTop = window.innerHeight - elmnt.offsetHeight;

      if (newLeft < minLeft) newLeft = minLeft;
      if (newTop < minTop) newTop = minTop;
      if (newLeft > maxLeft) newLeft = maxLeft;
      if (newTop > maxTop) newTop = maxTop;

      elmnt.style.top = newTop + "px";
      elmnt.style.left = newLeft + "px";
    }

    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  const historyContainer = document.getElementById("historyContainer");
  const historyHeader = document.getElementById("historyHeader");

  dragElement(historyContainer, historyHeader);

  // Close button hides the container
  document.getElementById("closeHistoryBtn").onclick = () => {
    historyContainer.style.display = "none";
  };
  function dragElement(elmnt) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

  const header = document.getElementById("messageHeader");
  if (header) {
    header.onmousedown = dragMouseDown;
  } else {
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;

    // If clicked element is input, textarea, or contenteditable, do NOT drag
    const target = e.target;
    if (
      target.tagName === "INPUT" || 
      target.tagName === "TEXTAREA" || 
      target.isContentEditable
    ) {
      return; // allow normal typing/focus
    }

    e.preventDefault();

    // Get the initial mouse cursor position
    pos3 = e.clientX;
    pos4 = e.clientY;

    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();

    // Calculate new cursor position
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;

    pos3 = e.clientX;
    pos4 = e.clientY;

    // Set the element's new position
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
  function toggleSettingsMenu() {
    const menu = document.getElementById("settingsMenu");
    menu.style.display = (menu.style.display === "block") ? "none" : "block";
  }

  // Optional: Hide the menu when clicking outside
  document.addEventListener("click", function (event) {
    const menu = document.getElementById("settingsMenu");
    const button = event.target.closest("button[title='Settings']");
    if (!menu.contains(event.target) && !button) {
      menu.style.display = "none";
    }
  });

  // Dummy logout function
  function logout() {
    localStorage.clear(); // or localStorage.removeItem("user_data");
    alert("Logged out successfully!");
    window.location.href = "home.html"; // Redirect after logout
  }
  function minimizeChat() {
    document.getElementById('messagesArea').style.display = 'none';
  }

  function maximizeChat() {
    document.getElementById('messagesArea').style.display = 'block';
  }
</script>

  <div class="main-content-wrapper">
 

    <!-- Main Items -->
    <div id="itemContainerGrouped"></div>

  </div>

  <footer class="footer">
    <div class="footer-content">
      <h3 data-i18n="site.footerTitle"></h3>
      <div class="contact-info">
        üìß <span data-i18n="site.emailLabel"></span>: <a href="mailto:secondarynp@gmail.com">secondarynp@gmail.com</a><br/>
        üìû <span data-i18n="site.contactLabel"></span>: <a href="tel:+9779866297346">9866297346</a>
      </div>
      <div class="copyright" data-i18n="site.copyright"></div>
    </div>
    <a href="admin_login.html">.</a>
  </footer>

  <script src="https://unpkg.com/i18next@22.4.7/i18next.min.js"></script>

  <script>
   const BASE_URL = "https://secondhandnab-production.up.railway.app";
    //${BASE_URL}

       function logout() {
   localStorage.removeItem("token");
    localStorage.removeItem("user_login_by");
    localStorage.removeItem("mode");
    localStorage.removeItem("user_data");
      const welcomeDiv = document.getElementById("welcomeMessage");
  if (welcomeDiv) {
    welcomeDiv.textContent = "";
  }
  }
    const IMAGE_BASE_URL = `${BASE_URL}/`;
    let allItems = [];
    const itemsPerPage = 10;
    const categoryPageIndex = {};



    async function buyItem(id, title, price, quantity) {
      
      if (quantity <= 0) {
        alert(i18next.t('site.outOfStock'));
        return;
      }

      try {
                   const user_mode=localStorage.getItem('mode');
            const email_buyer=localStorage.getItem('user_data');
           const user_login_by_name=localStorage.getItem('user_login_by');
           if(user_login_by_name&&user_mode==='user'){
        const response = await fetch(`${BASE_URL}/api/items/initiate-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ id, title, price ,email_buyer})
        });

        if (!response.ok) throw new Error("Failed to initiate payment.");
        const data = await response.json();
        localStorage.setItem("khaltiPidx", data.pidx);

        if (data.payment_url) {
          window.location.href = data.payment_url;
        } else {
          alert("Payment URL not received from server.");
        }}
        else{
         alert("You have not logged in as a user. Not allowed to buy in seller mode. Redirecting to login...");
setTimeout(() => {
  window.location.href = 'login1.html';
}, 0.0); // 2000 ms = 2 seconds

        }
      } catch (error) {
        console.error("Error:", error);
        alert("Error initiating payment. Please try again.");
      }
    }

    function viewDetails(itemId) {
      window.location.href = `description.html?id=${itemId}`;
    }

    function groupItemsByCategory(items) {
      const grouped = {};
      items.forEach(item => {
        const cat = item.category.toLowerCase();
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      });
      return grouped;
    }

    function renderCategorySection(items, category, page = 0, showAll = false) {
      if (!categoryPageIndex[category]) categoryPageIndex[category] = 0;

      if (showAll) {
        
        categoryPageIndex[category] = 0;
        const row = document.getElementById(`row-${category}`);
        row.innerHTML = '';

        items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'item-card';

          const img = document.createElement('img');
          img.src = item.imageUrl;
          img.alt = item.title;
          img.addEventListener('click', () => viewDetails(item.id));

          const details = document.createElement('div');
          details.className = 'item-details';
          details.addEventListener('click', () => viewDetails(item.id));

          const title = document.createElement('h3');
          title.textContent = item.title;

          const priceBuyRow = document.createElement('div');
          priceBuyRow.className = 'price-buy-row';

          const price = document.createElement('p');
          price.className = 'item-price';
          price.textContent = `NPR ${item.price}`;

          const buyBtn = document.createElement('button');
          buyBtn.textContent = i18next.t('site.buyNow');
          buyBtn.disabled = item.quantity <= 0;
          buyBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  openBuyPanel(item);
});

          // Add stock status
          const stockStatus = document.createElement('p');
          stockStatus.className = 'stock-status';
          stockStatus.textContent = item.quantity > 0 
            ? `${item.quantity} ${i18next.t('site.inStock')}`
            : i18next.t('site.outOfStock');
          stockStatus.style.color = item.quantity > 0 ? '#4CAF50' : '#F44336';

          priceBuyRow.appendChild(price);
          priceBuyRow.appendChild(buyBtn);
          details.appendChild(title);
          details.appendChild(priceBuyRow);
          details.appendChild(stockStatus);
          card.appendChild(img);
          card.appendChild(details);
          row.appendChild(card);
        });

        return;
      }

      categoryPageIndex[category] = page % Math.ceil(items.length / itemsPerPage);

      let start = categoryPageIndex[category] * itemsPerPage;
      let visibleItems = [];

      if (start + itemsPerPage <= items.length) {
        visibleItems = items.slice(start, start + itemsPerPage);
      } else {
        const endPart = items.slice(start);
        const neededFromStart = itemsPerPage - endPart.length;
        const startPart = items.slice(0, neededFromStart);
        visibleItems = endPart.concat(startPart);
      }

      const row = document.getElementById(`row-${category}`);
      row.innerHTML = '';

      visibleItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';

        const img = document.createElement('img');
        img.src = item.imageUrl;
        img.alt = item.title;
        img.addEventListener('click', () => viewDetails(item.id));

        const details = document.createElement('div');
        details.className = 'item-details';
        details.addEventListener('click', () => viewDetails(item.id));

        const title = document.createElement('h3');
        title.textContent = item.title;

        const priceBuyRow = document.createElement('div');
        priceBuyRow.className = 'price-buy-row';

        const price = document.createElement('p');
        price.className = 'item-price';
        price.textContent = `NPR ${item.price}`;
        
        const buyBtn = document.createElement('button');
        buyBtn.textContent = i18next.t('site.buyNow');
        buyBtn.disabled = item.quantity <= 0;
buyBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  openBuyPanel(item);
});



        // Add stock status
        const stockStatus = document.createElement('p');
        stockStatus.className = 'stock-status';
        stockStatus.textContent = item.quantity > 0 
          ? `${item.quantity} ${i18next.t('site.inStock')}`
          : i18next.t('site.outOfStock');
        stockStatus.style.color = item.quantity > 0 ? '#4CAF50' : '#F44336';

        priceBuyRow.appendChild(price);
        priceBuyRow.appendChild(buyBtn);
        details.appendChild(title);
        details.appendChild(priceBuyRow);
        details.appendChild(stockStatus);
        card.appendChild(img);
        card.appendChild(details);
        row.appendChild(card);
      });
    }

    function renderAllCategories(groupedItems) {
      const container = document.getElementById('itemContainerGrouped');
      container.innerHTML = '';

      Object.keys(groupedItems).forEach(category => {
        categoryPageIndex[category] = 0;

        const section = document.createElement('div');
        section.className = 'category-block';

        const title = document.createElement('h2');
        title.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        section.appendChild(title);

        const row = document.createElement('div');
        row.className = 'item-row';
        row.id = `row-${category}`;
        section.appendChild(row);

        const controls = document.createElement('div');
        controls.className = 'category-controls';

        const nextBtn = document.createElement('button');
        nextBtn.textContent = i18next.t('site.next');
        nextBtn.onclick = () => {
          const nextPage = categoryPageIndex[category] + 1;
          renderCategorySection(groupedItems[category], category, nextPage);
        };

        const allBtn = document.createElement('button');
        allBtn.textContent = i18next.t('site.all');
        allBtn.onclick = () => renderCategorySection(groupedItems[category], category, 0, true);

        controls.appendChild(nextBtn);
        controls.appendChild(allBtn);
        section.appendChild(controls);

        container.appendChild(section);

        renderCategorySection(groupedItems[category], category);
      });
    }





      // Search button event listener
      document.getElementById('searchBtn').addEventListener('click', () => {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const selectedCategory = document.getElementById('categoryFilter').value.toLowerCase();

        const filteredItems = allItems.filter(item => {
          const matchesSearch = item.title.toLowerCase().includes(searchText) ||
                item.description.toLowerCase().includes(searchText);
          const matchesCategory = selectedCategory === 'all' ||
                item.category.toLowerCase().trim() === selectedCategory;
          return matchesSearch && matchesCategory;
        });

        renderAllCategories(groupItemsByCategory(filteredItems));
      });
   
    window.addEventListener("DOMContentLoaded", () => {
  const welcomeDiv = document.getElementById("welcomeMessage");

  const loginMode = localStorage.getItem("mode"); // 'seller' or 'user'
  const loginByName = localStorage.getItem("user_data"); // person name or email
  const isLoggedIn = localStorage.getItem("user_login_by") !== null;

  if (isLoggedIn && loginMode && loginByName) {
    const modeLabel = loginMode === "seller" ? "Sell" : "Buy";
    welcomeDiv.textContent = `Welcome to ${modeLabel}, ${loginByName}`;
  } else {
    welcomeDiv.textContent = "";
  }
});


      async function loadItems() {
        try {
          const res = await fetch(`${BASE_URL}/api/items`, {
            method: 'GET',
            credentials: 'include'
          });
          allItems = await res.json();
          // Ensure each item has a quantity property (default to 1 if not provided)
          allItems = allItems.map(item => ({
            ...item,
            quantity: item.quantity !== undefined ? item.quantity : 1
          }));
          renderAllCategories(groupItemsByCategory(allItems));
        } catch (err) {
          console.error('Error loading items:', err);
          document.getElementById('itemContainerGrouped').innerHTML = '<p style="color:red;">Failed to load items.</p>';
        }
      }

let currentBuyItem = null;
let selleremail=null;
// Open the panel with item info
function openBuyPanel(item) {
  currentBuyItem = item;
  selleremail=item.email;
  console.log(selleremail);
  document.getElementById('buyPanel').style.display = 'flex';
  document.getElementById('deliveryForm').reset();

  const preview = document.getElementById('buyItemPreview');
  preview.innerHTML = `
    <img src="${item.imageUrl}" alt="${item.title}" style="width:100%; height:200px; object-fit:cover; border-radius:8px;">
    <h3>${item.title}</h3>
    <p><strong>Price:</strong> NPR ${item.price}</p>
    <p><strong>Stock:</strong> ${item.quantity > 0 ? item.quantity : 'Out of stock'}</p>
  `;
}

// Close and reset the panel
function closeBuyPanel() {
  document.getElementById('buyPanel').style.display = 'none';
  currentBuyItem = null;
  document.getElementById('deliveryForm').reset();
}

// Buy button click handler (validates form, saves data, and proceeds to payment)
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('finalBuyBtn').addEventListener('click', () => {
    const name = document.getElementById('deliveryName').value.trim();
    const email1 =localStorage.getItem('user_data');
    const phone = document.getElementById('deliveryPhone').value.trim();
    const address = document.getElementById('deliveryAddress').value.trim();
const { id, title, price, quantity } = currentBuyItem;
    if (!name || !email1 || !validatePhone(phone) || !address||!validateEmail(email1)) {
        if (!validateEmail(email1)) {
      alert("Please login to buy");
      return;
    }
     else if (!validatePhone(phone)) {
      alert("Please enter a valid Phone number.");
      return;
    }
    else{

      alert("Please fill in all delivery details.");
      return;}
    }
    

   const Secondhand_accountholder=localStorage.getItem("user_data");

    if (!currentBuyItem) return;

localStorage.setItem('deliveryInfo', JSON.stringify({ name, email1, phone, address }));

fetch(`${BASE_URL}/api12/orders`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    name: name,
    email: email1,
    phone: phone,
    address: address,
    itemId: id,
    itemTitle: title,
    itemPrice: price,
    itemQuantity: quantity,
    sellerEmail:selleremail,
    secondhandAccountholder: Secondhand_accountholder
   
  })
})
.then(res => res.text())
.then(msg => {
  console.log(msg);
  alert("Order placed: " + msg);
  closeBuyPanel();
  buyItem(id, title, price, quantity);
})
.catch(err => {
  console.error(err);
  alert("Failed to place order. Please try again.");
});

 
  
  });
});
function validatePhone(phone) {
  // Remove spaces and dashes
  const cleaned = phone.replace(/[\s-]/g, '');

  // Nepali phone numbers are usually 10 digits and start with 9
  const phoneRegex = /^9\d{9}$/;

  return phoneRegex.test(cleaned);
}

// Optional: Email format validation
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}</script>


    <script src="translation.js"></script>
  <script src="close_history.js"></script>
  <script src="chat_ko_lagi.js"></script>
  
<!-- Buy Panel -->
<div id="buyPanel"
  style="display: none; position: fixed; top: 80px; left: calc(50% - 350px); width: 700px; background: white; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 10000; overflow: hidden;">

  <!-- Top Header -->
  <div id="buyPanelHeader"
    style="cursor: move; padding: 12px 20px; background: #ffca28; display: flex; justify-content: space-between; align-items: center; user-select: none;">
    <h3 style="margin: 0;">Delivery Info</h3>
    
  </div>

  <!-- Main Content Below Header -->
  <div style="display: flex; padding: 20px; gap: 20px;">
    <!-- Left: Item Preview -->
    <div id="buyItemPreview" style="flex: 1;">
      <!-- JS will insert preview content here -->
    </div>

    <!-- Right: Delivery Form -->
    <div style="flex: 1;">
      <form id="deliveryForm" style="margin-bottom:15px;">
        <div style="margin-bottom:12px;">
          <label>Name:</label>
          <input type="text" id="deliveryName" required style="width:100%; padding:6px;">
        </div>
      
        <div style="margin-bottom:12px;">
          <label>Phone:</label>
          <input type="tel" id="deliveryPhone" required style="width:100%; padding:6px;">
        </div>
        <div style="margin-bottom:12px;">
          <label>Full Address:</label>
          <textarea id="deliveryAddress" required style="width:100%; padding:6px; min-height:80px;"></textarea>
        </div>
      </form>

      <div style="display:flex;">
        <button id="finalBuyBtn"
          style="background-color:#ff6f00; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:14px;">
          Buy
        </button>
        <button onclick="closeBuyPanel()"
          style="background-color:#ccc; padding:8px 16px; border-radius:4px; margin-left:10px; border:none; cursor:pointer; font-size:14px;">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function dragElement12(elmnt, handle) {
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

  handle.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    if (e.target.tagName === "BUTTON") return; // don't drag if clicking button
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;

    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e.preventDefault();

    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;

    let newTop = elmnt.offsetTop - pos2;
    let newLeft = elmnt.offsetLeft - pos1;

    const maxLeft = window.innerWidth - elmnt.offsetWidth;
    const maxTop = window.innerHeight - elmnt.offsetHeight;

    if (newLeft < 0) newLeft = 0;
    if (newTop < 0) newTop = 0;
    if (newLeft > maxLeft) newLeft = maxLeft;
    if (newTop > maxTop) newTop = maxTop;

    elmnt.style.top = newTop + "px";
    elmnt.style.left = newLeft + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

// Enable drag on header
dragElement12(document.getElementById("buyPanel"), document.getElementById("buyPanelHeader"));

function closeBuyPanel() {
  document.getElementById("buyPanel").style.display = "none";
}
</script>





</body>
</html>